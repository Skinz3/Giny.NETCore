@using Giny.IO.D2I;
@using Giny.IO.D2O;
@using Giny.IO.D2OClasses;
@using Giny.World.Records.Maps;
@using Giny.World.Records.Monsters;
@using Giny.WorldEditor.Caching;
@using Giny.WorldEditor.Components.Roleplay.Dialogs;
@using Giny.WorldEditor.Config;
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Components;
@using MudBlazor.Services;
@using System.Reflection;
@using System.Collections;
@using Giny.ORM;
@inject IDialogService DialogService


<MudGrid>
    <MudItem xs="3">

        <MudPaper Outlined=true>
            <MudList Dense="true" Clickable="true">
                <MudListSubheader>
                    <MudTextField Label="Search" TextChanged=OnSearchTextChanged @bind-Value="@Search"
                                  AdornmentColor="Color.Primary" AdornmentIcon="@Icons.Filled.Search"
                                  Adornment="Adornment.End" Immediate="true" Variant="Variant.Outlined" />
                </MudListSubheader>

                <div style="height:70vh;overflow-y:scroll">
                    <Virtualize Items="@DungeonSearchResults">
                        <MudListItem OnClick="() => SelectDungeon(context)" Text=@(context.Name + " ("+context.Rooms.Count+")") />
                    </Virtualize>
                </div>

            </MudList>

        </MudPaper>
    </MudItem>


    @if (SelectedDungeon != null)
    {
        <MudItem xs="9">
            <MudPaper MinHeight="900px" Class="d-flex flex-column flex-grow-1 gap-4 pa-6" Outlined=false Elevation="3">

                <div>
                    <MudText Typo="Typo.h5"> @SelectedDungeon.Name</MudText>
                    <MudText Typo="Typo.caption">Level @SelectedDungeon.OptimalPlayerLevel </MudText>
                </div>


                <div class="d-flex pa-2 gap-4">
                    <MudTextField Adornment="Adornment.Start" AdornmentIcon="@Icons.Outlined.LocationOn" ReadOnly=@true Value="@SelectedDungeon.EntranceMapId" Label="Entrée" />
                    <MudTextField Adornment="Adornment.Start" AdornmentIcon="@Icons.Outlined.LocationOn" ReadOnly=@true Value="@SelectedDungeon.ExitMapId" Label="Sortie" />

                </div>


                <MudTabs AlwaysShowScrollButtons="false" Color="Color.Surface" @bind-ActivePanelIndex="@RoomIndex" Elevation="0" Outlined=true Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">


                    @foreach (var room in SelectedDungeon.Rooms)
                    {
                        <MudTabPanel Text="@("Room "+(SelectedDungeon.Rooms.IndexOf(room)+1).ToString())">




                            @if (RoomIndex >= 0)
                            {
                                <div class="d-flex pa-2">
                                    <MudTextField Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.DriveFileRenameOutline" ReadOnly=@true Value="@MapPositionRecord.GetMapName(CurrentRoom.MapId)" Label="Name" />

                                </div>
                                <div class="d-flex gap-4 pa-2">
                                    <MudTextField Adornment="Adornment.Start" AdornmentIcon="@Icons.Outlined.LocationOn" ReadOnly=@true Value="@CurrentRoom.MapId" Label="MapId" />
                                    <MudTextField Adornment="Adornment.Start" AdornmentIcon="@Icons.Outlined.Timer" @bind-Value="@CurrentRoom.RespawnDelay" Label="Respawn delay" />

                                </div>



                                @if (CurrentRoom.MonsterIds.Count > 0)
                                {

                                    <MudDataGrid Class="mt-3" Dense=true Hover=true Striped=false Bordered=true Items="room.MonsterIds">
                                        <Columns>

                                            <TemplateColumn Title="Icon">
                                                <CellTemplate>
                                                    <MudImage Src="@(GetMonsterIcon(context.Item))" />
                                                </CellTemplate>
                                            </TemplateColumn>

                                            <TemplateColumn Title="Name">
                                                <CellTemplate>
                                                    <div class="d-flex gap-2">
                                                        <MudText Style="font-weight:600">(@context.Item)</MudText>
                                                        <MudText Style="font-weight:500">@MonsterRecord.GetMonsterRecord(context.Item).Name</MudText>
                                                    </div>

                                                </CellTemplate>
                                            </TemplateColumn>




                                            <TemplateColumn Title="Actions">
                                                <CellTemplate>
                                                    <MudStack Row>
                                                    <MudButton @onclick="()=> this.DeleteMonster(context.Item)" Size="@Size.Small" StartIcon="@Icons.Material.Filled.Delete" IconColor="Color.Primary" Variant="@Variant.Text" Color="@Color.Primary">Delete</MudButton>
                                                </MudStack>
                                            </CellTemplate>
                                        </TemplateColumn>

                                    </Columns>
                                </MudDataGrid>
                                }
                                else
                                {
                                    <MudChip Class="mt-2" Color="Color.Primary" Variant="Variant.Text">No monsters in this room</MudChip>
                                }

                            }

                            <MudButton StartIcon="@Icons.Material.Filled.Add" OnClick="AddMonster" Variant="Variant.Text" Color="Color.Primary">Add monster</MudButton>

                        </MudTabPanel>
                    }


                </MudTabs>



            </MudPaper>


        </MudItem>


    }
</MudGrid>

@code {


    List<MonsterRecord> SearchResults
    {
        get;
        set;
    } = new List<MonsterRecord>();

    string GetMonsterIcon(short monsterId)
    {
        var source = string.Format("data:image/png;base64,{0}", ExternalResources.GetMonsterIcon(monsterId));
        return source;
    }
    void DeleteMonster(short monsterId)
    {
        CurrentRoom.MonsterIds.Remove(monsterId);
        StateHasChanged();
        SelectedDungeon.UpdateLater();
    }
    async void AddMonster()
    {
        var result = await DialogHelper.OpenDialog<SelectMonsterDialog>(DialogService, new DialogParameters<SelectMonsterDialog>(), "Select monster");

        if (!result.Cancelled)
        {
            var record = (MonsterRecord)result.Data;
            CurrentRoom.MonsterIds.Add((short)record.Id);
            StateHasChanged();
        }

        SelectedDungeon.UpdateLater();

    }



    private string Search
    {
        get;
        set;
    } = "";
    private DungeonRecord SelectedDungeon
    {
        get; set;
    }
    private int RoomIndex
    {
        get;
        set;
    }
    private List<DungeonRecord> DungeonSearchResults
    {
        get;
        set;
    } = new List<DungeonRecord>();

    public MonsterRoom CurrentRoom => SelectedDungeon.Rooms.ElementAt(RoomIndex);

    private void SelectDungeon(DungeonRecord dungeon)
    {
        this.SelectedDungeon = dungeon;
        RoomIndex = 0;
    }
    private void OnSearchTextChanged()
    {
        DungeonSearchResults = DungeonRecord.GetDungeonRecords().Where(x => x.ToString().ToLower().Contains(Search.ToLower())).ToList();
        StateHasChanged();
    }

    protected override void OnInitialized()
    {

    }
}
